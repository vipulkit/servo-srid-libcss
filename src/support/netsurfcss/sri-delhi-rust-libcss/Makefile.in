VPATH=%VPATH%

CC ?= gcc
CXX ?= g++
CXXFLAGS ?=
AR ?= ar
RUSTC ?= rustc

RUST_SRC=$(shell find $(VPATH)/. -type f -name '*.rs')
#RUSTCSERVO = $(RUSTC)
#$(VPATH)/../../../../build/x86_64-unknown-linux-gnu/src/compiler/rust/x86_64-unknown-linux-gnu/stage2/bin/rustc

.PHONY: all
all:	libcss.dummy

libcss.dummy:
	#$(VPATH)/../../../../build/x86_64-unknown-linux-gnu/src/compiler/rust/x86_64-unknown-linux-gnu/stage2/bin/rustc -v
	$(RUSTC) -v
	#$(RUSTCSERVO) -v
	#$(RUSTC) -O $(VPATH)/libwapcaplet/wapcaplet.rs
	export LD_LIBRARY_PATH=.:$(VPATH)/libcss/libparserutils/:$LD_LIBRARY_PATH
	gcc -fPIC -shared $(VPATH)/libcss/libparserutils/input/iconv_wrapper.c -o libiconv_wrapper.so
	#rm -f aliases.rs
	#$(RUSTCSERVO) $(VPATH)/libcss/libparserutils/charset/aliases_gen.rs
	#$(VPATH)/libparserutils/charset/aliases_gen
	#$(RUSTC) -O -L . $(VPATH)/libcss/libparserutils/parserutils.rc --link-args -liconv_wrapper
	#rm -f autogenerated.rs
	#$(RUSTCSERVO) $(VPATH)/libcss/css_property_parser_gen.rs -o css_properties_parser_gen
	#$(VPATH)/libcss/css_properties_parser_gen
	$(RUSTC) -O -L . $(VPATH)/libcss/srid_css.rc  --link-args -liconv_wrapper
	#cd $(VPATH)/libcss; make; cd -
	cp $(VPATH)/libparserutils/*.so .
	cp $(VPATH)/libcss/*.so .


css-test: css.rc $(RUST_SRC)
	$(RUSTC) $(RUSTFLAGS) $< -o $@ --test

.PHONY: check
check: css-test
	./css-test

.PHONY: clean
clean:
	rm -f *.o *.a *.so *.dylib *.dll *.dummy *-test $(VPATH)/libcss/*.so 


