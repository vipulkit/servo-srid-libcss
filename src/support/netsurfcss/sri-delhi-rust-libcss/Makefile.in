VPATH=%VPATH%

CC ?= gcc
CXX ?= g++
CXXFLAGS ?=
AR ?= ar
RUSTC ?= rustc

RUST_SRC=$(shell find $(VPATH)/. -type f -name '*.rs')
RUSTCSERVO=$(VPATH)/../../../../build/x86_64-unknown-linux-gnu/src/compiler/rust/x86_64-unknown-linux-gnu/stage2/bin/rustc

.PHONY: all
all:	libcss.dummy

libcss.dummy:
	$(VPATH)/../../../../build/x86_64-unknown-linux-gnu/src/compiler/rust/x86_64-unknown-linux-gnu/stage2/bin/rustc -v
	$(RUSTCSERVO) -O $(VPATH)/libwapcaplet/wapcaplet.rs
	export LD_LIBRARY_PATH=.:$(VPATH)/libparserutils/:$LD_LIBRARY_PATH
	gcc -fPIC -shared $(VPATH)/libparserutils/input/iconv_wrapper.c -o libiconv_wrapper.so
	#rm -f aliases.rs
	#$(RUSTCSERVO) $(VPATH)/libparserutils/charset/aliases_gen.rs
	#$(VPATH)/libparserutils/charset/aliases_gen
	$(RUSTCSERVO) -O -L . $(VPATH)/libparserutils/parserutils.rc --link-args -liconv_wrapper
	#rm -f autogenerated.rs
	#$(RUSTCSERVO) $(VPATH)/libcss/css_property_parser_gen.rs -o css_properties_parser_gen
	#$(VPATH)/libcss/css_properties_parser_gen
	$(RUSTCSERVO) -O -L . -L $(VPATH)/../../../../build/x86_64-unknown-linux-gnu/src/compiler/rust/x86_64-unknown-linux-gnu/stage2/lib/ $(VPATH)/libcss/css.rc 

	#cd $(VPATH)/libwapcaplet; make; cd -
	#cd $(VPATH)/libparserutils; make; cd -
	#cd $(VPATH)/libcss; make; cd -
	#cp $(VPATH)/libwapcaplet/*.so .
	#cp $(VPATH)/libparserutils/*.so .
	#cp $(VPATH)/libcss/*.so .


css-test: css.rc $(RUST_SRC)
	$(RUSTC) $(RUSTFLAGS) $< -o $@ --test

.PHONY: check
check: css-test
	./css-test

.PHONY: clean
clean:
	rm -f *.o *.a *.so *.dylib *.dll *.dummy *-test


